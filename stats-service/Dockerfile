FROM node:18-alpine

# âœ… Î•ÏÎ³Î±Î»ÎµÎ¯Î± Î³Î¹Î± native modules (Ï€.Ï‡. bcrypt, amqplib)
RUN apk add --no-cache python3 make g++

# ğŸ”¹ Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Î±ÏÏ‡Î¹ÎºÎ¿Ï Ï†Î±ÎºÎ­Î»Î¿Ï… Ï„Î¿Ï… service
WORKDIR /app/stats-service

# 1ï¸âƒ£ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® Î¼ÏŒÎ½Î¿ Ï„Ï‰Î½ package*.json Ï„Î¿Ï… common
COPY common/package*.json ../common/

# 2ï¸âƒ£ Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎµÎ¾Î±ÏÏ„Î®ÏƒÎµÏ‰Î½ Ï„Î¿Ï… shared module (Ï€.Ï‡. amqplib)
RUN cd ../common && npm install --production

# 3ï¸âƒ£ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® package.json Ï„Î¿Ï… service
COPY stats-service/package*.json ./

# 4ï¸âƒ£ Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· service ÎµÎ¾Î±ÏÏ„Î®ÏƒÎµÏ‰Î½
RUN npm install

# 5ï¸âƒ£ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® ÏŒÎ»Î¿Ï… Ï„Î¿Ï… ÎºÏÎ´Î¹ÎºÎ± (service + common)
COPY stats-service/ ./
COPY common/ ../common/

# 6ï¸âƒ£ Î†Î½Î¿Î¹Î³Î¼Î± Î¸ÏÏÎ±Ï‚
EXPOSE 5004

# 7ï¸âƒ£ Î•ÎºÎºÎ¯Î½Î·ÏƒÎ·
CMD ["npm", "start"]
